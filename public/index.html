<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bybit Signal Detector - Messages</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }





        .messages-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .message {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #4CAF50;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: block;
            text-align: center;
        }

        .message:hover {
            transform: translateX(5px) scale(1.02);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .message-image {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 8px;
            margin: 15px auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: block;
        }

        .message-header {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }

        .timestamp {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
        }

        .message-content {
            line-height: 1.8;
            text-align: center;
        }

        .message-line {
            margin: 8px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ff6b6b;
            font-size: 1.2em;
        }



        .scan-finished {
            border-left-color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }

        .no-messages {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }

        /* Scrollbar styling */
        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        @media (max-width: 768px) {
            .message {
                padding: 15px;
            }

            .message-image {
                max-width: 100%;
            }

            .timestamp {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="messages-container" id="messagesContainer">
            <div class="loading">üîÑ Loading messages...</div>
        </div>
    </div>

    <script>
        let messages = [];
        let socket = null;

        // WebSocket connection
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;

            socket = new WebSocket(wsUrl);

            socket.onopen = function() {
                console.log('WebSocket connected');
            };

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'new_message') {
                    // Add new message to the beginning of the array
                    messages.unshift(data.message);
                    // Keep only last 100 messages
                    if (messages.length > 100) {
                        messages.splice(100);
                    }
                    renderMessages();
                }
            };

            socket.onclose = function() {
                console.log('WebSocket disconnected');
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };

            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }



        async function loadMessages() {
            try {
                const response = await fetch('/api/messages');
                const data = await response.json();
                messages = data.messages || [];
                renderMessages();
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messagesContainer').innerHTML =
                    '<div class="error">‚ùå Error loading messages. Please try again.</div>';
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');

            if (messages.length === 0) {
                container.innerHTML = '<div class="no-messages">üì≠ No messages yet</div>';
                return;
            }

            const messagesHtml = messages.map(msg => {
                const isScanFinished = msg.text.includes('üîç Scan finished');
                const messageClass = isScanFinished ? 'message scan-finished' : 'message';
                const symbolInfo = getSymbolInfo(msg.text);

                return `
                    <a href="${symbolInfo.url}" target="_blank" class="${messageClass}">
                        <div class="message-header">
                            <div class="timestamp">${formatTimestamp(msg.timestamp)}</div>
                        </div>
                        ${msg.image ? `<img src="${msg.image}" alt="Chart" class="message-image">` : ''}
                        <div class="message-content">
                            ${formatMessageContent(msg.text)}
                        </div>
                    </a>
                `;
            }).join('');

            container.innerHTML = messagesHtml;
        }

        function getSymbolInfo(text) {
            const lines = text.split('\n');
            const firstLine = lines[0].trim();

            // Check if it's a scan finished message
            if (firstLine.includes('üîç Scan finished')) {
                return {
                    symbol: 'üîç Scan Finished',
                    url: '#'
                };
            }

            // Check if first line looks like a symbol (ends with USDT)
            if (firstLine.endsWith('USDT') && firstLine.length > 4) {
                const symbol = firstLine;
                const url = `https://www.bybit.com/trade/usdt/${symbol}`;
                return { symbol, url };
            }

            return {
                symbol: firstLine,
                url: '#'
            };
        }

        function formatMessageContent(text) {
            const lines = text.split('\n');
            return lines.map(line => 
                `<div class="message-line">${line || '&nbsp;'}</div>`
            ).join('');
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            // Convert to UTC+2
            const utcPlus2 = new Date(date.getTime() + (2 * 60 * 60 * 1000));

            // Format as DD/MM/YYYY HH:MM
            const day = utcPlus2.getUTCDate().toString().padStart(2, '0');
            const month = (utcPlus2.getUTCMonth() + 1).toString().padStart(2, '0');
            const year = utcPlus2.getUTCFullYear();
            const hours = utcPlus2.getUTCHours().toString().padStart(2, '0');
            const minutes = utcPlus2.getUTCMinutes().toString().padStart(2, '0');

            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        // Load initial messages and connect WebSocket
        loadMessages();
        connectWebSocket();
    </script>
</body>
</html>
